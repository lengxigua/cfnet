name: Deploy to Production

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  actions: read

env:
  HEALTH_CHECK_RETRIES: 5
  HEALTH_CHECK_DELAY: 15

jobs:
  deploy-production:
    name: Deploy to Cloudflare Pages (Production)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: production
      url: ${{ vars.PRODUCTION_DEPLOYMENT_URL || 'https://cloudflare-worker-template-prod.pages.dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Download build-artifacts from CI
        if: github.event_name != 'workflow_dispatch'
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}
          path: .vercel/output/static

      - name: Build for manual deployment
        if: github.event_name == 'workflow_dispatch'
        env:
          NODE_ENV: production
          CI: true
        run: |
          pnpm run build
          pnpm run pages:build

      - name: Show downloaded artifact files (debug)
        if: runner.debug == '1'
        shell: bash
        run: |
          echo "Workspace root:" && pwd
          echo "List root:" && ls -la . || true
          echo "List .vercel/output:" && ls -la .vercel/output || true
          echo "List .vercel/output/static:" && ls -la .vercel/output/static || true

      - name: Validate build artifacts exist
        shell: bash
        run: |
          if [ ! -d ".vercel/output/static" ] || [ -z "$(ls -A .vercel/output/static 2>/dev/null)" ]; then
            echo "âŒ Build artifacts not found at .vercel/output/static."
            echo "Please ensure the CI workflow uploads 'build-artifacts' via actions/upload-artifact."
            echo "CI must complete successfully before deploy triggers."
            exit 1
          fi

      - name: Run database migrations (wrangler.prod.toml)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations apply cloudflare-worker-template-prod --remote --config wrangler.prod.toml

      - name: Copy production config for Pages deployment
        run: cp wrangler.prod.toml wrangler.toml

      - name: Deploy to Cloudflare Pages (Production)
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy .vercel/output/static --project-name=cloudflare-worker-template-prod --branch=main

      - name: Health Check
        id: health-check
        shell: bash
        run: |
          # Use configured URL, or fallback to Cloudflare Pages default URL
          DEPLOYMENT_URL="${{ vars.PRODUCTION_DEPLOYMENT_URL }}"
          if [ -z "$DEPLOYMENT_URL" ]; then
            DEPLOYMENT_URL="https://cloudflare-worker-template-prod.pages.dev"
          fi
          HEALTH_ENDPOINT="${DEPLOYMENT_URL}/api/health"

          echo "ðŸ” Running health check on $HEALTH_ENDPOINT"

          for i in $(seq 1 ${{ env.HEALTH_CHECK_RETRIES }}); do
            echo "Attempt $i/${{ env.HEALTH_CHECK_RETRIES }}..."

            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_ENDPOINT" || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Health check passed! (HTTP $HTTP_STATUS)"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "â³ Health check returned HTTP $HTTP_STATUS, retrying in ${{ env.HEALTH_CHECK_DELAY }}s..."
            sleep ${{ env.HEALTH_CHECK_DELAY }}
          done

          echo "âŒ Health check failed after ${{ env.HEALTH_CHECK_RETRIES }} attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Alert on deployment failure
        if: failure()
        shell: bash
        run: |
          echo "ðŸš¨ PRODUCTION DEPLOYMENT FAILURE ðŸš¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Critical: Production Health Check Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Immediate Actions Required:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check Cloudflare Pages dashboard for deployment status" >> $GITHUB_STEP_SUMMARY
          echo "2. Review application logs for errors" >> $GITHUB_STEP_SUMMARY
          echo "3. Consider rolling back to previous deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback Instructions:**" >> $GITHUB_STEP_SUMMARY
          echo "- Go to Cloudflare Pages Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "- Select the project: cloudflare-worker-template-prod" >> $GITHUB_STEP_SUMMARY
          echo "- Go to Deployments tab" >> $GITHUB_STEP_SUMMARY
          echo "- Find the previous successful deployment" >> $GITHUB_STEP_SUMMARY
          echo "- Click 'Rollback to this deployment'" >> $GITHUB_STEP_SUMMARY

      - name: Create deployment summary
        if: success()
        run: |
          echo "### ðŸš€ Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | **Production** |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ vars.PRODUCTION_DEPLOYMENT_URL || 'https://cloudflare-worker-template-prod.pages.dev' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Deployed At | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
