name: Deploy to Test Environment

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [develop, preview]

permissions:
  contents: read
  actions: read
  pull-requests: write

env:
  HEALTH_CHECK_RETRIES: 5
  HEALTH_CHECK_DELAY: 10

jobs:
  deploy-test:
    name: Deploy to Cloudflare Pages (Test)
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: test
      url: ${{ vars.TEST_DEPLOYMENT_URL || 'https://cloudflare-worker-template-test.pages.dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Download build-artifacts from CI
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}
          path: .vercel/output/static

      - name: Show downloaded artifact files (debug)
        if: runner.debug == '1'
        shell: bash
        run: |
          echo "Workspace root:" && pwd
          echo "List root:" && ls -la . || true
          echo "List .vercel/output:" && ls -la .vercel/output || true
          echo "List .vercel/output/static:" && ls -la .vercel/output/static || true

      - name: Validate build artifacts exist
        shell: bash
        run: |
          if [ ! -d ".vercel/output/static" ] || [ -z "$(ls -A .vercel/output/static 2>/dev/null)" ]; then
            echo "âŒ Build artifacts not found at .vercel/output/static."
            echo "Please ensure the CI workflow uploads 'build-artifacts' via actions/upload-artifact."
            echo "CI must complete successfully before deploy triggers."
            exit 1
          fi

      - name: Run database migrations (wrangler.test.toml)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 migrations apply cloudflare-worker-template-test --remote --config wrangler.test.toml

      - name: Copy test config for Pages deployment
        run: cp wrangler.test.toml wrangler.toml

      - name: Deploy to Cloudflare Pages (Test)
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy .vercel/output/static --project-name=cloudflare-worker-template-test

      - name: Health Check
        id: health-check
        shell: bash
        run: |
          # Use configured URL, or fallback to Cloudflare Pages default URL
          DEPLOYMENT_URL="${{ vars.TEST_DEPLOYMENT_URL }}"
          if [ -z "$DEPLOYMENT_URL" ]; then
            DEPLOYMENT_URL="https://cloudflare-worker-template-test.pages.dev"
          fi
          HEALTH_ENDPOINT="${DEPLOYMENT_URL}/api/health"

          echo "ðŸ” Running health check on $HEALTH_ENDPOINT"

          for i in $(seq 1 ${{ env.HEALTH_CHECK_RETRIES }}); do
            echo "Attempt $i/${{ env.HEALTH_CHECK_RETRIES }}..."

            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_ENDPOINT" || echo "000")

            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Health check passed! (HTTP $HTTP_STATUS)"
              echo "status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "â³ Health check returned HTTP $HTTP_STATUS, retrying in ${{ env.HEALTH_CHECK_DELAY }}s..."
            sleep ${{ env.HEALTH_CHECK_DELAY }}
          done

          echo "âŒ Health check failed after ${{ env.HEALTH_CHECK_RETRIES }} attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Rollback on failure
        if: failure() && steps.health-check.outputs.status == 'failed'
        shell: bash
        run: |
          echo "ðŸ”„ Health check failed - initiating rollback notification"
          echo "âš ï¸ Manual rollback may be required. Please check Cloudflare Pages dashboard."
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ Deployment Failed - Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment completed but the health check failed." >> $GITHUB_STEP_SUMMARY
          echo "Please investigate and consider rolling back in Cloudflare Pages dashboard." >> $GITHUB_STEP_SUMMARY

      - name: Get associated PR number
        id: pr
        if: github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            const pullRequests = github.event.workflow_run.pull_requests;
            if (pullRequests && pullRequests.length > 0) {
              return pullRequests[0].number;
            }
            return '';

      - name: Comment PR with deployment URL
        if: steps.pr.outputs.result != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.result }};
            const deploymentUrl = process.env.TEST_DEPLOYMENT_URL || 'https://cloudflare-worker-template-test.pages.dev';
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Deployed to test environment!\n\n**URL**: ${deploymentUrl}\n**Commit**: ${context.payload.workflow_run.head_sha.substring(0, 7)}\n**Health Check**: âœ… Passed`
            })
        env:
          TEST_DEPLOYMENT_URL: ${{ vars.TEST_DEPLOYMENT_URL }}

      - name: Create deployment summary
        if: success()
        run: |
          echo "### ðŸš€ Test Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Test |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ vars.TEST_DEPLOYMENT_URL || 'https://cloudflare-worker-template-test.pages.dev' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.event.workflow_run.head_sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.event.workflow_run.head_branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Health Check | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
